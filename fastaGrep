#!/usr/bin/env ruby

require 'bio'
require 'ZFile'
require 'trollop'

ARGV.push("--help") if ARGV.empty?
opts = Trollop::options do
  banner File.basename($0)
  opt :input, "Input fasta file", :required=>true, :type=>:string
  opt :file, "Read patterns from file", :type=>:string
  opt :pattern, "pattern to match header", :type=>:strings
  opt :fastq, "Read fastq format rather than fasta"
  opt :inverse, "Return things not matching"
  opt :nostrand, "cut off strand info when matching"
end

if opts.fastq
  form = Bio::Fastq
else
  form = Bio::FastaFormat
end

patterns = Hash.new
if opts.file
  File.new(opts.file).each do |line|
    fields = line.chomp.split(" ")
    patterns[fields.first] = true
  end
else
  opts.pattern.each do |pat|
    patterns[pat] = true
  end
end

if patterns.keys.empty?
  STDERR << File.basename($0)+": Search pattern required\n"
  exit(1)
end

Bio::FlatFile.new(form, ZFile.new(opts.input)).each do |seq|
  name = seq.entry_id
  name = name.gsub(/\/1|\/2/,"") if opts.nostrand
  if patterns[name]
    print seq if !opts.inverse
  else
    print seq if opts.inverse
  end
end
