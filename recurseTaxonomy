#!/usr/bin/env ruby

require 'rubygems'
require 'trollop'
require 'mysql'

ARGV.push("--help") if ARGV.empty?
opts = Trollop::options do
  banner File.basename($0)
  opt :input, "tax num(s)", :type=>:strings, :required=>true
  opt :file, "input is file, not tax nums themselves"
  opt :taxonomy, "use taxonomy text file from phylodb not db", :type=>:string
  opt :nodes, "use NCBI nodes.dmp", :type=>:string
  opt :names, "use NCBI names.dmp (with nodes.dmp)", :type=>:string
  opt :only, "only use official (kpcofgs) ranks"
  opt :verbose, "verbose messaging"
end

if (!opts.taxonomy && !opts.nodes)
  db = Mysql.new("mysql-lan-pro", "access", "access", "phylodb")
elsif (opts.taxonomy)
  tax = Hash.new
  File.new(opts.taxonomy).each do |line|
    current, name, parent, rank = line.chomp.split("\t")
    tax[current.to_i] = [name, parent.to_i, rank]
  end
  db = tax
elsif (opts.nodes)
  tax = Hash.new
  names = Hash.new
  File.new(opts.names).each do |line|
    num, name = line.chomp.split("\t|\t")
    names[num.to_i] = name if !names[num.to_i]
  end
  File.new(opts.nodes).each do |line|
    current, parent, rank = line.chomp.split("\t|\t")
    tax[current.to_i] = [names[current.to_i], parent.to_i, rank]
  end
  db = tax
end

def recurseTaxonomy(db, current, official, verbose)
  if (db.class == Hash)
    name, parent, rank = db[current]
  else
    name, parent, rank = db.query("SELECT name, parent_id, rank FROM taxonomy WHERE taxon_id=#{current}").fetch_row
  end
  if (name.nil? || parent.to_i == 1)
    []
  else
    ranks = ["kingdom", "phylum", "class", "order", "family", "genus", "species", "no rank"]
    name = name + " (" + current.to_s + ")" if verbose
    if (!official || (ranks.include?(rank.downcase)))
      recurseTaxonomy(db, parent, official, verbose).to_a + [name]
    else
      recurseTaxonomy(db, parent, official, verbose).to_a
    end
  end
end

if (opts.file)
  ids = []
  File.new(opts.input).each do |line|
    ids.push(line.chomp.to_i)
  end
else
  ids = opts.input
end

opts.input.each do |id|
  print id + "\t " + recurseTaxonomy(db, id.to_i, opts.only, opts.verbose).join("; ") + "\n"
end
