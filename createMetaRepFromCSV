#!/usr/bin/env ruby

require 'optparse'
require 'ostruct'
require 'csv'
require 'ZFile'


opt = OpenStruct.new
opt.cluster = nil

o = OptionParser.new
o.banner << " csv [...csv]"
o.on("-c ", "--cluster-file ", String, "") {|c| opt.cluster = c}
begin
  o.parse!
rescue
  STDERR << $!.message << "\n"
  STDERR << o
  exit(1)
end
if (ARGV.size < 1)
  STDERR << o
  exit(1)
end

if (opt.cluster)
  cluster = Hash.new
  STDERR << "Loading clusters...\n"
  ZFile.new(opt.cluster).each do |line|
    pep, c1, c2 = line.chomp.split("\t")
    cluster[pep] = c1 + "|| " + c2
  end
else
  cluster = nil
end

ARGV.each do |file|
  tab = File.basename(file).split(".csv").first + ".tab"
  out = File.new(tab, "w")
  ZFile.new(file).each do |line|
    line = line.parse_csv
    sname, dataset, len, ann, tax, taxid, blastid, blastann, blaste, blastident, blastcov = line
    next if sname == "Seq Name"
    meta = [sname, dataset, ann, "APIS", go, gosrc, ec, ecsrc, hmm, blastid, blaste, blastident, blastcov, ""]
  end
  out.close
end